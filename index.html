<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MPES Timer MCTM (Version 9.9.25 at 9.57am)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
      background-color: #f9f9f9;
    }
    h1 { margin-bottom: 12px; }

    /* Top controls */
    .top-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      align-items: end;
      max-width: 1000px;
      margin: 0 auto 8px;
      text-align: left;
    }
    .field { display: flex; flex-direction: column; gap: 6px; }
    input[type="text"], input[type="date"], select {
      padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px;
    }
    label { font-weight: 600; }

    #global-timer {
      font-size: 24px;
      margin: 15px 0;
    }

    /* Timer grid */
    .timer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 10px;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }
    .timer-box {
      background-color: #ccc;
      border: 1px solid #bbb;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
    }
    .timer-box h3 { margin-top: 0; }
    .timer-box.active { background-color: #4CAF50; color: white; }

    .start-button, .stop-button, .reset-button {
      margin: 8px;
      padding: 8px 16px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .start-button { background-color: #4CAF50; color: white; }
    .stop-button { background-color: #f44336; color: white; }
    .reset-button { background-color: #9e9e9e; color: white; }

    /* Force 2×2 layout on small screens, with slightly smaller boxes */
    @media (max-width: 620px) {
      .timer-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .timer-box { padding: 10px; border-radius: 12px; }
      .timer-box h3 { font-size: 14px; }
      .start-button { width: 100%; padding: 6px 10px; font-size: 14px; }
    }

    /* Matrix table */
    .matrix {
      margin-top: 24px; width: 100%;
    }
    .matrix table {
      margin: 0 auto;
      border-collapse: collapse;
      width: 100%;
      max-width: 800px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }
    .matrix td {
      padding: 10px; border: 1px solid #ccc; text-align: left;
    }
    .matrix tr:nth-child(even) { background-color: #f6f6f6; }

    .actions { margin: 18px 0 8px; }

    /* ===== COMPACT SUMMARY (≈25% shorter) ===== */
    .summary-section {
      max-width: 1000px;
      margin: 18px auto;             /* was 24px */
      text-align: left;
      display: none;
      font-size: 14px;               /* down from ~16px */
      line-height: 1.25;             /* tighter lines */
    }
    .summary-section h2 {
      text-align: center;
      font-size: 18px;               /* smaller heading */
      margin: 4px 0 8px;             /* tighter spacing */
    }
    .summary-table, .info-table {
      margin: 8px auto 16px;         /* was 12px auto 24px */
      border-collapse: collapse;
      width: 100%;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      table-layout: fixed;
    }
    .info-table th, .info-table td,
    .summary-table th, .summary-table td {
      border: 1px solid #ccc;
      padding: 5px 6px;              /* was 8px */
      font-size: 13px;               /* was inherit (~16) */
      vertical-align: middle;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .info-table th, .summary-table th { background-color: #f0f0f0; }

    .legend {
      max-width: 1000px;
      margin: 0 auto 8px;            /* was 14px */
      font-size: 12px;               /* smaller */
      color: #333;
      background: #fff;
      padding: 6px 8px;              /* was 10px 14px */
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .rating-group {
      display: flex; gap: 6px;       /* tighter gap */
      justify-content: flex-start; flex-wrap: wrap;
    }
    .rating-group label {
      display: inline-flex; align-items: center; gap: 4px;
      font-weight: 500; font-size: 13px;
    }
    .rating-label.selected { color: #c62828; font-weight: 600; }
    .rating-input.selected { accent-color: #c62828; }
    .selected-label { font-weight: 600; margin-bottom: 4px; display: inline-block; font-size: 13px; }

    .footer-note {
      font-size: 11px;               /* smaller */
      color: #666;
      text-align: center;
      margin-bottom: 12px;           /* was 24px */
    }

    /* Comments box slightly tighter */
    .summary-comments { min-height: 64px; padding: 6px; font-size: 13px; }
  </style>
</head>
<body>
  <h1>MCTM: MPES Timer Condensed Table (Version 9.9.25 at 9.57am)</h1>

  <!-- Top controls: Participant ID, Date, Duration, Global display -->
  <div class="top-controls">
    <div class="field">
      <label for="participant-id">Participant ID</label>
      <input id="participant-id" type="text" placeholder="Enter ID number (e.g., A12-034)" />
    </div>
    <div class="field">
      <label for="session-date">Session Date</label>
      <input id="session-date" type="date" />
    </div>
    <div class="field">
      <label for="duration-select">Timer Duration</label>
      <select id="duration-select" aria-label="Timer duration">
        <option value="60">1 Minute</option>
        <option value="120">2 Minutes</option>
        <option value="180">3 Minutes</option>
        <option value="240" selected>4 Minutes</option>
        <option value="300">5 Minutes</option>
      </select>
    </div>
    <div class="field">
      <label>Global Timer</label>
      <div id="global-timer">0.00s</div>
    </div>
  </div>

  <!-- Behavior Timers -->
  <div class="timer-grid">
    <div class="timer-box" id="box0">
      <h3>DID / COMMENTED</h3>
      <div id="timer0">0.00s</div>
      <button class="start-button" onclick="startTimer(0)">Start</button>
    </div>
    <div class="timer-box" id="box1">
      <h3>LISTENED / WATCHED</h3>
      <div id="timer1">0.00s</div>
      <button class="start-button" onclick="startTimer(1)">Start</button>
    </div>
    <div class="timer-box" id="box2">
      <h3>DID OTHER</h3>
      <div id="timer2">0.00s</div>
      <button class="start-button" onclick="startTimer(2)">Start</button>
    </div>
    <div class="timer-box" id="box3">
      <h3>SLEPT</h3>
      <div id="timer3">0.00s</div>
      <button class="start-button" onclick="startTimer(3)">Start</button>
    </div>
  </div>

  <!-- Binary/ordinal questions -->
  <div class="matrix">
    <table>
      <tr>
        <td>Did the person try to leave?</td>
        <td>
          <label><input type="radio" name="q1" value="0" checked> 0 (No)</label>
          <label><input type="radio" name="q1" value="1"> 1 (Yes)</label>
        </td>
      </tr>
      <tr>
        <td>Did the person actually leave?</td>
        <td>
          <label><input type="radio" name="q2" value="0" checked> 0 (No)</label>
          <label><input type="radio" name="q2" value="1"> 1 (Yes)</label>
        </td>
      </tr>
      <tr>
        <td>Was any pleasure displayed?</td>
        <td>
          <label><input type="radio" name="q8" value="0" checked> 0 (No)</label>
          <label><input type="radio" name="q8" value="1"> 1 (Yes)</label>
        </td>
      </tr>
      <tr>
        <td>Was any anxiety displayed?</td>
        <td>
          <label><input type="radio" name="q9" value="0" checked> 0 (No)</label>
          <label><input type="radio" name="q9" value="1"> 1 (Yes)</label>
        </td>
      </tr>
      <tr>
        <td>Did the person help?</td>
        <td>
          <label><input type="radio" name="q10" value="0" checked> 0 (No)</label>
          <label><input type="radio" name="q10" value="1"> 1 (Yes)</label>
        </td>
      </tr>
      <tr>
        <td>How many times did they help?</td>
        <td>
          <label><input type="radio" name="q10a" value="0" checked> 0 (0 times)</label>
          <label><input type="radio" name="q10a" value="1"> 1 (1–2 times)</label>
          <label><input type="radio" name="q10a" value="2"> 2 (3+ times)</label>
        </td>
      </tr>
      <tr>
        <td>Any inappropriate behavior?</td>
        <td>
          <label><input type="radio" name="q11" value="0" checked> 0 (No)</label>
          <label><input type="radio" name="q11" value="1"> 1 (Yes)</label>
        </td>
      </tr>
    </table>
  </div>

  <div class="actions">
    <button class="stop-button" onclick="showSummary()">DONE</button>
    <button class="reset-button" onclick="resetAllTimers()">RESET</button>
  </div>

  <!-- Summary (compact) -->
  <div id="summary" class="summary-section">
    <h2>Summary</h2>

    <div class="legend">
      <strong>Code legends:</strong>
      &nbsp;Binary: 0 (No), 1 (Yes) &nbsp;|&nbsp;
      Proportions: 0 (Not at all), 1 (Up to half), 2 (More than half)
    </div>

    <table class="info-table">
      <thead>
        <tr><th colspan="6">Session Info</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Participant ID</strong></td>
          <td id="info-id"></td>
          <td><strong>Date</strong></td>
          <td id="info-date"></td>
          <td><strong>Total Observed Duration</strong></td>
          <td id="info-duration"></td>
        </tr>
        <tr>
          <td><strong>Start Time</strong></td>
          <td id="info-start"></td>
          <td><strong>End Time</strong></td>
          <td id="info-end"></td>
          <td colspan="2"></td>
        </tr>
      </tbody>
    </table>

    <table class="summary-table" id="combined-table">
      <thead>
        <tr>
          <th>Category / Question</th>
          <th>Exact Time (s)</th>
          <th>Rating (change if needed)</th>
        </tr>
      </thead>
      <tbody id="combined-body"></tbody>
    </table>

    <!-- Comments section (compact) -->
    <div style="max-width:800px;margin:8px auto;">
      <label for="summary-comments" style="font-weight:600;display:block;margin-bottom:4px;">
        Comments / Notes:
      </label>
      <textarea id="summary-comments" class="summary-comments"
        style="width:100%;border-radius:8px;border:1px solid #ccc;resize:vertical;"
        placeholder="Type any additional observations or notes here..."></textarea>
    </div>

    <div class="footer-note">Change any rating below if needed. If you change it, only the chosen option turns red, and any previously changed row reverts to its auto value.</div>
  </div>

  <script>
    /* =======================
       iOS/Mac-accurate timing
       ======================= */
    const labels = ["DID / COMMENTED", "LISTENED / WATCHED", "DID OTHER", "SLEPT"];

    // Category timers: {accum: seconds, start: performance timestamp or null}
    const timers = labels.map(() => ({ accum: 0, start: null }));
    // Global timer
    const globalTimer = { accum: 0, start: null };

    let currentActive = null;        // active category index, or null
    let rafId = null;                // requestAnimationFrame id
    let sessionStartAt = null;       // Date
    let sessionEndAt = null;         // Date
    let lastChangedCell = null;      // for summary red-highlight behavior

    const durationSel = document.getElementById('duration-select');

    // DOM refs
    const globalEl = document.getElementById('global-timer');
    const summaryEl = document.getElementById('summary');
    const summaryBody = document.getElementById('combined-body');

    // Utility: high-resolution monotonic time (seconds)
    const nowSec = () => performance.now() / 1000;

    // Compute elapsed seconds for a timer-like object
    function getElapsed(t) {
      return t.start == null ? t.accum : t.accum + (nowSec() - t.start);
    }

    function getTargetDuration() {
      const v = parseInt(durationSel.value || '240', 10);
      if (Number.isFinite(v)) return v;
      return 240; // default to 4 minutes
    }

    function formatSecs(s) { return s.toFixed(2) + 's'; }
    function formatTimeHMSS(d) {
      if (!d) return "—";
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    // Display update
    function updateDisplay() {
      for (let i = 0; i < 4; i++) {
        const sec = getElapsed(timers[i]);
        document.getElementById(`timer${i}`).textContent = formatSecs(sec);
        document.getElementById(`box${i}`).classList.toggle('active', currentActive === i);
      }
      const g = getElapsed(globalTimer);
      globalEl.textContent = formatSecs(g);
    }

    // Start a category
    function startTimer(index) {
      if (!sessionStartAt) sessionStartAt = new Date();

      // Start global loop if not running
      if (globalTimer.start == null) {
        globalTimer.start = nowSec();
        tick();
      }

      // Pause any currently active category
      if (currentActive !== null && timers[currentActive].start != null) {
        pauseCategory(currentActive);
      }

      // Start new active category
      currentActive = index;
      if (timers[index].start == null) timers[index].start = nowSec();

      // Hide summary if restarting
      if (summaryEl.style.display !== "none") summaryEl.style.display = "none";

      updateDisplay();
    }

    function pauseCategory(index) {
      const t = timers[index];
      if (t.start != null) {
        t.accum += (nowSec() - t.start);
        t.start = null;
      }
    }

    function stopAllTimers() {
      if (currentActive !== null) {
        pauseCategory(currentActive);
        currentActive = null;
      }
      if (globalTimer.start != null) {
        globalTimer.accum += (nowSec() - globalTimer.start);
        globalTimer.start = null;
      }
      if (rafId != null) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }
      updateDisplay();
    }

    function resetAllTimers() {
      stopAllTimers();
      // Reset categories and global
      timers.forEach(t => { t.accum = 0; t.start = null; });
      globalTimer.accum = 0; globalTimer.start = null;

      // Reset session times and UI
      sessionStartAt = null; sessionEndAt = null;
      summaryEl.style.display = "none";
      document.querySelectorAll("input[type='radio'][value='0']").forEach(r => r.checked = true);
      lastChangedCell = null;
      updateDisplay();
    }

    // Animation loop (accurate even if frames are delayed)
    function tick() {
      if (globalTimer.start == null) { rafId = null; return; }

      const g = getElapsed(globalTimer);
      updateDisplay();

      // Auto-stop at selected duration
      if (g >= getTargetDuration()) {
        stopAllTimers();
        if (!sessionEndAt) sessionEndAt = new Date();
        return;
      }

      rafId = requestAnimationFrame(tick);
    }

    // ===== Helpers for summary/rating UI =====
    function proportionToAutoCode(part, total) {
      if (total <= 0) return 0;
      if (part === 0) return 0;
      if (part <= total / 2) return 1;
      return 2;
    }
    function ratingCodeToLabel(code) {
      switch (Number(code)) {
        case 0: return "0 (Not at all)";
        case 1: return "1 (Up to half)";
        case 2: return "2 (More than half)";
        default: return String(code);
      }
    }
    function yesNoLabel(code) { return Number(code) === 1 ? "1 (Yes)" : "0 (No)"; }
    function helpFreqLabel(code) {
      if (Number(code) === 0) return "0 (0 times)";
      if (Number(code) === 1) return "1 (1–2 times)";
      return "2 (3+ times)";
    }

    function buildRatingCell({ options, autoValue, labelFor, onChange, onReset }) {
      const td = document.createElement("td");
      const container = document.createElement("div");
      container.className = "rating-cell";
      container.dataset.autoValue = String(autoValue);

      const selected = document.createElement("div");
      selected.className = "selected-label";
      selected.textContent = labelFor(autoValue);
      container.appendChild(selected);

      const group = document.createElement("div");
      group.className = "rating-group";

      const groupName = "rg-" + Math.random().toString(36).slice(2);
      const inputs = [];
      const labelsEls = [];

      function clearRedStyles() {
        inputs.forEach(inp => inp.classList.remove("selected"));
        labelsEls.forEach(lab => lab.classList.remove("selected"));
      }

      function setToAuto() {
        const a = container.dataset.autoValue;
        inputs.forEach(inp => { inp.checked = (inp.value === a); });
        selected.textContent = labelFor(a);
        clearRedStyles();
        if (typeof onReset === "function") onReset(a);
      }

      options.forEach(val => {
        const lab = document.createElement("label");
        lab.className = "rating-label";

        const inp = document.createElement("input");
        inp.type = "radio";
        inp.className = "rating-input";
        inp.name = groupName;
        inp.value = String(val);
        if (String(val) === String(autoValue)) inp.checked = true;

        inp.addEventListener("change", () => {
          if (window.lastChangedCell && window.lastChangedCell !== container) {
            const reset = window.lastChangedCell._resetToAuto;
            if (typeof reset === "function") reset();
          }
          selected.textContent = labelFor(val);

          clearRedStyles();
          if (String(val) !== String(container.dataset.autoValue)) {
            inp.classList.add("selected");
            lab.classList.add("selected");
            window.lastChangedCell = container;
          } else if (window.lastChangedCell === container) {
            window.lastChangedCell = null;
          }
          if (typeof onChange === "function") onChange(val);
        });

        lab.appendChild(inp);
        lab.appendChild(document.createTextNode(labelFor(val)));
        group.appendChild(lab);

        inputs.push(inp);
        labelsEls.push(lab);
      });

      container._resetToAuto = setToAuto;
      container.appendChild(group);
      td.appendChild(container);
      return td;
    }

    // Question defs (binary/trinary)
    const questionDefs = [
      { name: "q1",  label: "Tried to Leave",          type: "binary" },
      { name: "q2",  label: "Left",                    type: "binary" },
      { name: "q8",  label: "Pleasure",                type: "binary" },
      { name: "q9",  label: "Anxiety",                 type: "binary" },
      { name: "q10", label: "Helped",                  type: "binary" },
      { name: "q10a",label: "Helped Frequency",        type: "trinary" },
      { name: "q11", label: "Inappropriate Behavior",  type: "binary" },
    ];

    function addBehaviorRow(tbody, idx, numberText, label) {
      const exact = getElapsed(timers[idx]);
      const total = getElapsed(globalTimer);
      const autoCode = proportionToAutoCode(exact, total);

      const row = document.createElement("tr");

      const tdCat = document.createElement("td");
      tdCat.textContent = `${numberText}) ${label}`;
      row.appendChild(tdCat);

      const tdTime = document.createElement("td");
      tdTime.textContent = exact.toFixed(2);
      row.appendChild(tdTime);

      const tdRating = buildRatingCell({
        options: [0,1,2],
        autoValue: autoCode,
        labelFor: ratingCodeToLabel
      });
      row.appendChild(tdRating);

      tbody.appendChild(row);
    }

    function addQuestionRow(tbody, q, numberText) {
      const autoVal = (document.querySelector(`input[name='${q.name}']:checked`) || { value: "0" }).value;

      const row = document.createElement("tr");

      const tdCat = document.createElement("td");
      tdCat.textContent = `${numberText}) ${q.label}`;
      row.appendChild(tdCat);

      const tdTime = document.createElement("td");
      tdTime.textContent = "";
      row.appendChild(tdTime);

      const opts = q.type === "binary" ? [0,1] : [0,1,2];
      const tdRating = buildRatingCell({
        options: opts,
        autoValue: autoVal,
        labelFor: (v) => q.type === "binary" ? yesNoLabel(v) : helpFreqLabel(v),
        onChange: (val) => {
          const original = document.querySelector(`input[name='${q.name}'][value='${val}']`);
          if (original) original.checked = true;
        },
        onReset: (auto) => {
          const originalAuto = document.querySelector(`input[name='${q.name}'][value='${auto}']`);
          if (originalAuto) originalAuto.checked = true;
        }
      });
      row.appendChild(tdRating);

      tbody.appendChild(row);
    }

    function addParticipatedRow(tbody, numberText) {
      const anyDidOrListened = (getElapsed(timers[0]) > 0) || (getElapsed(timers[1]) > 0);
      const autoVal = anyDidOrListened ? 1 : 0;

      const row = document.createElement("tr");

      const tdCat = document.createElement("td");
      tdCat.textContent = `${numberText}) Participated`;
      row.appendChild(tdCat);

      const tdTime = document.createElement("td");
      tdTime.textContent = "";
      row.appendChild(tdTime);

      const tdRating = buildRatingCell({
        options: [0,1],
        autoValue: autoVal,
        labelFor: yesNoLabel
      });
      row.appendChild(tdRating);

      tbody.appendChild(row);
    }

    // Summary
    function showSummary() {
      stopAllTimers();
      sessionEndAt = new Date();

      const pid = document.getElementById("participant-id").value.trim() || "(none entered)";
      const dateVal = document.getElementById("session-date").value || "(none selected)";
      document.getElementById("info-id").innerText = pid;
      document.getElementById("info-date").innerText = dateVal;
      document.getElementById("info-duration").innerText = formatSecs(getElapsed(globalTimer));
      document.getElementById("info-start").innerText = formatTimeHMSS(sessionStartAt);
      document.getElementById("info-end").innerText = formatTimeHMSS(sessionEndAt);

      summaryBody.innerHTML = "";

      addParticipatedRow(summaryBody, "1");                                 // 1) Participated
      addQuestionRow(summaryBody, questionDefs.find(q => q.name==="q1"), "2");
      addQuestionRow(summaryBody, questionDefs.find(q => q.name==="q2"), "3");
      addBehaviorRow(summaryBody, 0, "4",  "DID / COMMENTED");
      addBehaviorRow(summaryBody, 1, "5",  "LISTENED / WATCHED");
      addBehaviorRow(summaryBody, 2, "6",  "DID OTHER");
      addBehaviorRow(summaryBody, 3, "7",  "SLEPT");
      addQuestionRow(summaryBody, questionDefs.find(q => q.name==="q8"), "8");
      addQuestionRow(summaryBody, questionDefs.find(q => q.name==="q9"), "9");
      addQuestionRow(summaryBody, questionDefs.find(q => q.name==="q10"), "10");
      addQuestionRow(summaryBody, questionDefs.find(q => q.name==="q10a"), "10a");
      addQuestionRow(summaryBody, questionDefs.find(q => q.name==="q11"), "12");

      summaryEl.style.display = "block";
      window.scrollTo({ top: summaryEl.offsetTop - 10, behavior: "smooth" });
    }

    // Init page (set date, paint)
    (function init() {
      const dateInput = document.getElementById("session-date");
      const now = new Date();
      const tzoffset = now.getTimezoneOffset() * 60000;
      const local = new Date(now - tzoffset).toISOString().slice(0,10);
      dateInput.value = local;

      updateDisplay();
    })();
  </script>
</body>
</html>
